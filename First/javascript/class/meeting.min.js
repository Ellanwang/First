(function(){meeting={view_book:{Initialization:function(){common.menusInitialization();meeting.view_book.showTypes();meeting.view_book.page_list(1);$(".search").click(function(){if($(".form-search").validationEngine("validate")){meeting.view_book.page_list(1)}});$("body").delegate(".data-list a","click",function(e){common.cookies.set("orderRoomId",$(e.currentTarget).find(".list-one .num").text());common.cookies.set("startDateTime",$("#startTime").val());common.cookies.set("endDateTime",$("#endTime").val())})},showTypes:function(){var param={};webserver.query(param,apipath.meeting.types.list,methods.search,function(error,data,layerIndex){var html="";for(var i=0;i<data.length;i++){html=html+'<option value="'+data[i].typeId+'">'+data[i].typeName+"</option>"}$("#typeId").append(html);layer.close(layerIndex)})},page_list:function(current_page){var param={page:current_page,rows:pagination.view_book_rows_count};param.floor=$("#floor").val();param.maxSize=$("#maxSize").val();param.typeId=$("#typeId").val();param.rStatus=$("#rStatus").val();param.startTime=$("#startTime").val();param.endTime=$("#endTime").val();webserver.query(param,apipath.meeting.room.list,methods.search,meeting.view_book.callback_search)},callback_search:function(err,data,layerIndex){var html="";if(data.total&&data.total>0){for(var i=0;i<data.list.length;i++){html=html+"<li>"+'<a href="meetingRoomOrder.html">'+'<ul class="list-one">'+'<li class="num">'+data.list[i]["roomId"]+"</li>"+'<li class="hys">'+"<p>"+data.list[i]["roomName"]+"</p>"+data.list[i]["roomFloor"]+"楼"+data.list[i]["roomLocation"]+"室</li>"+'<li class="rl">'+"容量"+data.list[i]["roomSize"]+"人"+"</li>"+'<li class="lb">'+data.list[i]["typeName"]+"</li>"+'<li class="ss">';for(var j=0;j<data.list[i].equipList.length;j++){html=html+data.list[i].equipList[j]["equipName"]+"  "}html=html+"</li>"+'<li class="zt">';var color="blue";if(data.list[i]["voStatus"]=="空闲"){color="blue"}else if(data.list[i]["voStatus"]=="已预订"){color="green"}else if(data.list[i]["voStatus"]=="使用中"){color="red"}else if(data.list[i]["voStatus"]=="故障"){color="red"}html=html+'<span class="'+color+'">'+data.list[i]["voStatus"]+"</span>"+"</li>"+"</ul>"+"</a>"+"</li>"}}pagination.Initialization(data.total,pagination.view_book_rows_count,data.pageNum,meeting.view_book.page_list);$(".data-list").html(html);layer.close(layerIndex)}},manage:{Initialization:function(){common.menusInitialization();meeting.manage.page_list(1);$("body").delegate(".data-list a","click",function(e){common.cookies.set("orderRoomId",$(e.currentTarget).find(".list-one .num").text());common.cookies.delete("startDateTime");common.cookies.delete("endDateTime")});$("body").delegate(".btn-delete","click",function(e){e.stopPropagation();e.preventDefault();var name=$(e.currentTarget).parent().siblings("li.hys").children("p").text();common.showConfirm("请您确认以下信息：","您将删除会议室："+name,function(){},function(){var id=$(e.currentTarget).parent().siblings("li.num").text();webserver.query(null,apipath.meeting.room.delete+id,methods.delete)})});$("body").delegate(".btn-details","click",function(e){e.stopPropagation();e.preventDefault();var roomId=$(e.currentTarget).parent().siblings("li.num").text();var d1=$.Deferred();var d2=$.Deferred();var d3=$.Deferred();meeting.manage.showTypes(d1);meeting.manage.showEquips(d2);meeting.manage.showRoomDetail(d3,roomId);$.when(d1,d2,d3).done(function(v1,v2,v3){common.showPopbox("修改会议室信息",$("#meeting_add"),function(){var roomEquips=v3.roomEquip.split(",");for(var i=0;i<roomEquips.length;i++){$('.equips input:checkbox[value="'+roomEquips[i]+'"]').attr("checked","true")}$("#floor").val(v3.roomFloor);$("#room").val(v3.roomLocation);$("#name").val(v3.roomName);$("#number").val(v3.roomNo);$("#personnum").val(v3.roomSize);$("#types").val(v3.roomType)},function(layerindex){if($(".meeting-form").validationEngine("validate")){var param={};var equips_chk_value=[];$('.equips input[name="equipslist"]:checked').each(function(){equips_chk_value.push($(this).val())});param.roomEquip=equips_chk_value.join(",");param.roomFloor=$("#floor").val();param.roomLocation=$("#room").val();param.roomName=$("#name").val();param.roomNo=$("#number").val();param.roomSize=$("#personnum").val();param.roomType=$("#types").val();webserver.query(param,apipath.meeting.room.edit+roomId,methods.edit);layer.close(layerindex)}})})});$(".list-box li .btn").click(function(){var d1=$.Deferred();var d2=$.Deferred();meeting.manage.showTypes(d1);meeting.manage.showEquips(d2);$.when(d1,d2).done(function(v1,v2){common.showPopbox("新增会议室",$("#meeting_add"),function(){$("#floor").val("");$("#room").val("");$("#name").val("");$("#number").val("");$("#personnum").val("");$("#types").val("")},function(layerindex){if($(".meeting-form").validationEngine("validate")){var param={};var equips_chk_value=[];$('.equips input[name="equipslist"]:checked').each(function(){equips_chk_value.push($(this).val())});param.roomEquip=equips_chk_value.join(",");param.roomFloor=$("#floor").val();param.roomLocation=$("#room").val();param.roomName=$("#name").val();param.roomNo=$("#number").val();param.roomSize=$("#personnum").val();param.roomType=$("#types").val();webserver.query(param,apipath.meeting.room.add,methods.add);layer.close(layerindex)}})})});meeting.manage.showTypes();meeting.manage.showEquips();$("#types_add_a").click(function(){common.showPopbox("新增会议室分类",$("#types_add"),function(){},function(layerindex){if($('#types_add input[name="typename"]').val()!==""){var param={};param.typeName=$('#types_add input[name="typename"]').val();webserver.query(param,apipath.meeting.types.add,methods.add);layer.close(layerindex)}})});$("#types_edit_a").click(function(){var chk_value=[];$('.types-ck input[name="typeslist"]:checked').each(function(){chk_value.push({id:$(this).val(),name:$(this).next("label").text()})});if(chk_value.length!==1){layer.msg("请您选择一项进行修改",{icon:0});return}common.showPopbox("修改会议室分类",$("#types_add"),function(){$('#types_add input[name="typename"]').val(chk_value[0]["name"])},function(layerindex){if($('#types_add input[name="typename"]').val()!==""){var param={};param.typeName=$('#types_add input[name="typename"]').val();webserver.query(param,apipath.meeting.types.edit+chk_value[0]["id"],methods.edit);layer.close(layerindex)}})});$("#types_delete_a").click(function(){var chk_value=[];$('.types-ck input[name="typeslist"]:checked').each(function(){chk_value.push({id:$(this).val(),name:$(this).next("label").text()})});if(chk_value.length===0){layer.msg("请您至少选择一项进行删除",{icon:0});return}var namearr=new Array;var idarr=new Array;for(var i=0;i<chk_value.length;i++){namearr.push(chk_value[i]["name"]);idarr.push(chk_value[i]["id"])}common.showConfirm("请您确认以下信息：","您将删除会议室类型："+namearr.join("、"),function(){},function(){webserver.query(null,apipath.meeting.types.delete+idarr.join(","),methods.delete)})});$("#equips_add_a").click(function(){common.showPopbox("新增会议室设备",$("#equips_add"),function(){},function(layerindex){if($('#equips_add input[name="equipname"]').val()!==""){var param={};param.equipName=$('#equips_add input[name="equipname"]').val();webserver.query(param,apipath.meeting.equips.add,methods.add);layer.close(layerindex)}})});$("#equips_edit_a").click(function(){var chk_value=[];$('.equips-ck input[name="equipslist"]:checked').each(function(){chk_value.push({id:$(this).val(),name:$(this).next("label").text()})});if(chk_value.length!==1){layer.msg("请您选择一项进行修改",{icon:0});return}common.showPopbox("修改会议室设备",$("#equips_add"),function(){$('#equips_add input[name="equipname"]').val(chk_value[0]["name"])},function(layerindex){if($('#equips_add input[name="equipname"]').val()!==""){var param={};param.equipName=$('#equips_add input[name="equipname"]').val();webserver.query(param,apipath.meeting.equips.edit+chk_value[0]["id"],methods.edit);layer.close(layerindex)}})});$("#equips_delete_a").click(function(){var chk_value=[];$('.equips-ck input[name="equipslist"]:checked').each(function(){chk_value.push({id:$(this).val(),name:$(this).next("label").text()})});if(chk_value.length===0){layer.msg("请您至少选择一项进行删除",{icon:0});return}var namearr=new Array;var idarr=new Array;for(var i=0;i<chk_value.length;i++){namearr.push(chk_value[i]["name"]);idarr.push(chk_value[i]["id"])}common.showConfirm("请您确认以下信息：","您将删除会议室设备："+namearr.join("、"),function(){},function(){webserver.query(null,apipath.meeting.equips.delete+idarr.join(","),methods.delete)})})},page_list:function(current_page){var param={page:current_page,rows:pagination.view_book_rows_count};webserver.query(param,apipath.meeting.room.list,methods.search,meeting.manage.callback_search)},callback_search:function(err,data,layerIndex){var html="";if(data.total&&data.total>0){for(var i=0;i<data.list.length;i++){html=html+"<li>"+'<a href="meetingRoomOrder.html">'+'<ul class="list-one">'+'<li class="num">'+data.list[i]["roomId"]+"</li>"+'<li class="hys">'+"<p>"+data.list[i]["roomName"]+"</p>"+data.list[i]["roomFloor"]+"楼"+data.list[i]["roomLocation"]+"</li>"+'<li class="rl">'+"容量"+data.list[i]["roomSize"]+"人"+"</li>"+'<li class="lb">'+data.list[i]["typeName"]+"</li>"+'<li class="ss">';for(var j=0;j<data.list[i].equipList.length;j++){html=html+data.list[i].equipList[j]["equipName"]+"  "}html=html+"</li>"+'<li class="zt">'+'<button class="btn-delete">删除</button> '+'<button class="btn-details">修改</button>'+"</li>"+"</ul>"+"</a>"+"</li>"}}pagination.Initialization(data.total,pagination.manage_rows_count,data.pageNum,meeting.manage.page_list);$(".data-list").html(html);layer.close(layerIndex)},showEquips:function(d){var param={};webserver.query(param,apipath.meeting.equips.list,methods.search,function(error,data,layerIndex){var html="";for(var i=0;i<data.length;i++){html=html+'<input name="equipslist" id="e'+i+'" value="'+data[i].equipId+'" type="checkbox" /><label for="e'+i+'">'+data[i].equipName+"</label>"}if(d){$(".pop-box .pop-txt .t-table .equips").html(html);d.resolve()}else{$(".equips-ck").html(html)}layer.close(layerIndex)})},showTypes:function(d){var param={};webserver.query(param,apipath.meeting.types.list,methods.search,function(error,data,layerIndex){var html="";if(d){for(var i=0;i<data.length;i++){html=html+'<option value="'+data[i].typeId+'">'+data[i].typeName+"</option>"}$(".pop-box .pop-txt .t-table .types").html(html);d.resolve()}else{for(var i=0;i<data.length;i++){html=html+'<input name="typeslist" id="t'+i+'" value="'+data[i].typeId+'" type="checkbox" /><label for="t'+i+'">'+data[i].typeName+"</label>"}$(".types-ck").html(html)}layer.close(layerIndex)})},showRoomDetail:function(d,roomId){webserver.query(null,apipath.meeting.room.single+roomId,methods.search,function(error,data,layerIndex){layer.close(layerIndex);if(d){d.resolve(data)}})}},orderTimes:{Initialization:function(){common.menusInitialization();var DateArr=common.myDate.setDate.getPreviousMonth();$("#startTime").val(common.myDate.dateFormat(DateArr[0],"yyyy-MM-dd"));$("#endTime").val(common.myDate.dateFormat(DateArr[1],"yyyy-MM-dd"));meeting.orderTimes.list();$(".search").click(function(){meeting.orderTimes.list()});$("body").delegate(".chart-box .btn-details","click",function(e){common.cookies.set("orderRoomId",$(e.currentTarget).attr("title"));common.cookies.set("startDateTime",$("#startTime").val());common.cookies.set("endDateTime",$("#endTime").val())})},list:function(){var param={};param.startTime=$("#startTime").val();param.endTime=$("#endTime").val();webserver.query(param,apipath.meeting.orderTimes.list,methods.search,meeting.orderTimes.callback_search)},callback_search:function(err,data,layerIndex){var html="";if(data.length&&data.length>0){var totaltimes=0;for(var i=0;i<data.length;i++){totaltimes=totaltimes+data[i].orderTimes}for(var i=0;i<data.length;i++){html=html+'<ul class="chart-box">'+'<li class="hys-details">'+"<p>"+data[i].roomName+"</p>"+"<a title="+data[i].roomId+' class="btn-details" href="meetingRoomStatisticsDetail.html">详情</a>'+"</li>"+'<li class="long">';var j=common.RandomNum(1,7);html=html+'<div class="color-'+j+'" style="width:'+(parseInt(totaltimes)===0?0:(parseFloat(data[i].orderTimes)/parseFloat(totaltimes)*100).toFixed(2))+'%;">22</div>'+'<span class="color-'+j+'">'+data[i].orderTimes+"次</span>"+"</li>"+"</ul>"}}$(".chartlist").html(html);layer.close(layerIndex)}},orderDetail:{Initialization:function(){common.menusInitialization();var roomId=common.cookies.get("orderRoomId");if(common.cookies.get("startDateTime")&&common.cookies.get("endDateTime")){$("#startTime").val(common.cookies.get("startDateTime").slice(0,10));$("#endTime").val(common.cookies.get("endDateTime").slice(0,10))}meeting.orderDetail.page_list(1,roomId);meeting.orderDetail.roomInfo(roomId);$(".search").click(function(){meeting.orderDetail.page_list(1,roomId)})},page_list:function(current_page,roomId){if(!roomId){roomId=common.cookies.get("orderRoomId")}var param={};param.startTime=$("#startTime").val();param.endTime=$("#endTime").val();param.page=current_page;param.rows=pagination.orderDetail_rows_count;webserver.query(param,apipath.meeting.orderDetail.list+roomId,methods.search,meeting.orderDetail.callback_search)},callback_search:function(err,data,layerIndex){var html="";if(data.total&&data.total>0){html="<tr>"+"<th>开始日期</th>"+"<th>结束时间</th>"+"<th>预定人</th>"+"<th>主持人</th>"+"<th>参会人员</th>"+"<th>主题</th>"+"</tr>";for(var i=0;i<data.list.length;i++){html=html+"<tr>"+"<td>"+common.myDate.dateFormat(data.list[i].orderStarttime,"yyyy-MM-dd hh:mm:ss")+"</td>"+"<td>"+common.myDate.dateFormat(data.list[i].orderEndtime,"yyyy-MM-dd hh:mm:ss")+"</td>"+"<td>"+data.list[i].orderUsername+"</td>"+"<td>"+(data.list[i].hostUser?data.list[i].hostUser.userName:'<span class="lightGrey">(无)</span>')+"</td>"+"<td>"+common.arrayList(data.list[i].attendList,"userName","、")+"</td>"+"<td>"+data.list[i].orderTopic+"</td>"+"</tr>"}}pagination.Initialization(data.total,pagination.orderDetail_rows_count,data.pageNum,meeting.orderDetail.page_list);$(".table-box").html(html);layer.close(layerIndex)},roomInfo:function(roomId){webserver.query(null,apipath.meeting.room.single+roomId,methods.search,function(error,data,layerIndex){$(".cur-page-txt span").html(roomId+" 号会议室使用详情");$(".hys-txt h2").html(data.roomName).siblings("p").html(data.roomFloor+"楼"+data.roomLocation+"室 &nbsp;|&nbsp; 容量"+data.roomSize+"人&nbsp; | &nbsp;"+data.typeName+"&nbsp; | &nbsp;"+common.arrayList(data.equipList,"equipName"," "));layer.close(layerIndex)})}},preOrder:{Initialization:function(){common.menusInitialization();var roomId=common.cookies.get("orderRoomId");meeting.preOrder.list(roomId);meeting.preOrder.roomInfo(roomId);$(".search").click(function(){meeting.preOrder.list(roomId)});$("body").delegate("ul[class^='day'] li.hy-set a.can-dy","click",function(e){common.showPopbox("会议室预定",$("#hysyd"),function(){$(".orderDate").html($(e.currentTarget).parents().siblings(".week").attr("title"));$(".orderUserName").html(JSON.parse(common.cookies.get("!@#2017hd_user")).userName);$("#topic").val("");$("#hostName").val("");$("#attendName").val("");$("#meetingEndTime").val($(e.currentTarget).find(".yd-end").text());$("#meetingStartTime").val($(e.currentTarget).find(".yd-start").text())},function(layerIndex){if($(".order-form").validationEngine("validate")){meeting.preOrder.confirmOrder(roomId,layerIndex,"add")}})});$("#hysyd a.importUsers").click(function(){common.showPopbox("导入与会人员",$("#drry"),function(){$("#deptId").val("");$("#userJob").val("");$("#name").val("");meeting.preOrder.deptDropList();meeting.preOrder.attendList()},function(layerindex){var attendUser=common.arrayPutList($('#drry .table-table input[name="attendUser"]:checked'),",");var targetIdArr=common.string2Array(attendUser.id,",");var targetNameArr=common.string2Array(attendUser.name,"、");var oldIdArr=common.string2Array($("#attendId").val(),",");var oldNameArr=common.string2Array($("#attendName").val(),"、");var mergeArrayId=common.mergeArray(oldIdArr,targetIdArr);var mergeArrayName=common.mergeArray(oldNameArr,targetNameArr);$("#attendName").val(mergeArrayName.mergeArray.join("、"));$("#attendId").val(mergeArrayId.mergeArray.join(","));layer.close(layerindex)})});$("#hysyd a.clearUsers").click(function(){$("#attendName").val("");$("#attendId").val("")});$("#drry .searchAttend").click(function(){meeting.preOrder.attendList()});$("body").delegate("#allcheck","click",function(e){$('#drry .table-table input[name="attendUser"]').each(function(){$(this).attr("checked",!!$(e.currentTarget).attr("checked"))})});$("body").delegate("ul[class^='day'] li.hy-set a.done","mouseover",function(e){common.showTips($(e.currentTarget).find("p").html(),$(e.currentTarget),$(e.currentTarget).css("background-color"),4e3)});$("body").delegate("ul[class^='day'] li.hy-set a.lready-dy","click",function(e){var orderId=$(e.currentTarget).find('input[name="orderId"]').val();layer.msg('<span style="color:#ffffff">请选择以下操作：</span>',{time:0,btn:["修改","删除"],shadeClose:true,shade:.3,btn1:function(index){layer.close(index);webserver.query(null,apipath.meeting.order.single+orderId,methods.search,function(error,data,layerIndex){common.showPopbox("修改会议室预定",$("#hysyd"),function(){$(".orderDate").html($(e.currentTarget).parents().siblings(".week").attr("title"));$(".orderUserName").html($(e.currentTarget).find(".orderUser").text());$("#topic").val($(e.currentTarget).find(".topic").text());$("#meetingEndTime").val($(e.currentTarget).find(".yd-end").text());$("#meetingStartTime").val($(e.currentTarget).find(".yd-start").text());$("#hostName").val(data.hostUser?data.hostUser.userName:'<span class="lightGrey">(无)</span>');$("#hostNamehid").val(data.hostUser.userId);$("#attendName").val(common.arrayList(data.attendList,"userName","、"));$("#attendId").val(common.arrayList(data.attendList,"userId",","))},function(layerIndex){if($(".order-form").validationEngine("validate")){meeting.preOrder.confirmOrder(0,layerIndex,"edit",orderId);layer.close(layerIndex)}});layer.close(layerIndex)})},btn2:function(index){layer.close(index);common.showPopbox("删除会议室预定",$("#qxyd"),function(){$("#qxyd .qxyd-orderUser").html($(e.currentTarget).find(".orderUser").text());$("#qxyd .qxyd-orderDate").html($(e.currentTarget).parents().siblings(".week").attr("title"));$("#qxyd .qxyd-orderTime").html($(e.currentTarget).find(".yd-start").text()+"-"+$(e.currentTarget).find(".yd-end").text());$("#qxyd_reason").val("");$("#qxyd_mark").val("")},function(layerIndex){meeting.preOrder.cancelOrder($(e.currentTarget).find('input[name="orderId"]').val(),layerIndex);layer.close(layerIndex)})}})});$("#hostName").bind("input propertychange",function(){$("#hostNamehid").val("")});$("#hostName").autocomplete({serviceUrl:apipath.meeting.users.list+"?userId=1&token=1&page=1&rows=10",type:"GET",dataType:"json",paramName:"name",zIndex:20891021,onSelect:function(suggestion){$("#hostNamehid").val(suggestion.data)},onHint:function(hint){$("#hostName-list").val(hint)},transformResult:function(response){return{suggestions:$.map(response.data.list,function(dataItem){return{value:dataItem.userName,data:dataItem.userId}})}},onInvalidateSelection:function(){}})},list:function(roomId){var timestamp=Date.parse(new Date);if(!$("#startTime").val()){$("#startTime").val(common.myDate.dateFormat(timestamp,"yyyy-MM-dd"))}$(".data-box h2").html(common.myDate.dateFormat(timestamp,"yyyy年MM月dd日"));webserver.query(null,apipath.meeting.preOrder.list+roomId+"/"+$("#startTime").val(),methods.search,meeting.preOrder.callback_search)},attendList:function(){var params={};params.page=1;params.rows=pagination.deptDropList_rows_count;params.deptId=$("#deptId").val();params.userJob=$("#userJob").val();params.name=$("#name").val();webserver.query(params,apipath.meeting.users.list,methods.search,meeting.preOrder.callback_attendList)},deptDropList:function(){var params={};params.page=1;params.rows=pagination.attendList_rows_count;webserver.query(params,apipath.meeting.dept.list,methods.search,function(error,data,layerIndex){var html='<option value="">不限</option>';for(var i=0;i<data.list.length;i++){html=html+'<option value="'+data.list[i].deptId+'">'+data.list[i].deptName+"</option>"}$("#deptId").html(html)})},callback_search:function(err,data,layerIndex){var firstDay=common.myDate.FirstDayOfWeek(new Date($("#startTime").val()));common.myDate.serverDate($("#startTime").val(),function(err,data,layerIndex){firstDay=data.monday;layer.close(layerIndex)});for(var i=0;i<7;i++){var datetime=new Date;if(i===0){datetime=datetime.setFullYear(firstDay.split("-")[0],parseInt(firstDay.split("-")[1])-1,parseInt(firstDay.split("-")[2])+6)}else{datetime=datetime.setFullYear(firstDay.split("-")[0],parseInt(firstDay.split("-")[1])-1,parseInt(firstDay.split("-")[2])+(i-1))}$(".time-set .day"+i+" .week").attr("title",common.myDate.dateFormat(datetime,"yyyy-MM-dd")).find("p span").text(common.myDate.dateFormat(datetime,"dd")).parents().parents().siblings(".hy-set").html("")}var basicwidth=parseFloat(100/14/60/60/1e3);if(data.length&&data.length>0){for(var i=0;i<data.length;i++){meeting.preOrder.showOrderModule(data[i],basicwidth)}}var thisweekfirstDay=common.myDate.FirstDayOfWeek(new Date);var _week=(new Date).getDay();common.myDate.serverDate("",function(err,data,layerIndex){thisweekfirstDay=data.monday;_week=data.week;layer.close(layerIndex)});$(".time-set .week").removeClass("cur-week");if(Date.parse(thisweekfirstDay)===Date.parse(firstDay)){$(".time-set .day"+_week+" .week").addClass("cur-week")}if(Date.parse(firstDay)>=Date.parse(thisweekfirstDay)){var getToday=common.myDate.dateFormat(new Date,"yyyy-MM-dd");for(var i=0;i<7;i++){var currentDay=$(".time-set .day"+i+" .week").attr("title");if(Date.parse(thisweekfirstDay)===Date.parse(firstDay)&&(currentDay>=getToday||i===0)||Date.parse(firstDay)>Date.parse(thisweekfirstDay)){var a_count=$(".time-set .day"+i+" .hy-set").children("a.done").length;var nowDateStartPosition=(Date.parse(new Date)-Date.parse(common.myDate.dateFormat(Date.parse(new Date),"yyyy-MM-dd")+" 06:00:00"))*basicwidth;if(a_count>0){var parentwidth=$(".time-set .day"+i+" .hy-set").css("width").replace("px","");$(".time-set .day"+i+" .hy-set a.done").each(function(){var thismarginleft=parseFloat($(this).css("margin-left").replace("px",""))/parentwidth*100;var lastHtml="";var prevcount=$(this).prev("a.done").length;if(prevcount){var premarginleft=parseFloat($(this).prev("a.done").css("margin-left").replace("px",""))/parentwidth*100;var prewidth=$(this).prev("a.done").css("width").replace("px","")/parentwidth*100;var orderbtnwidth=thismarginleft-prewidth-premarginleft;var can_dy_startPosition=prewidth+premarginleft;if(orderbtnwidth>2.4){if(getToday===currentDay){if(nowDateStartPosition>can_dy_startPosition){if(nowDateStartPosition<thismarginleft-2.4){orderbtnwidth=orderbtnwidth-(nowDateStartPosition-can_dy_startPosition);can_dy_startPosition=nowDateStartPosition;lastHtml='<a style="width:'+(orderbtnwidth-.1)+"%;margin-left: "+(can_dy_startPosition+.1)+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+common.myDate.dateFormat((new Date).setMinutes((new Date).getMinutes()+10),"hh:mm")+'</span><span class="yd-end">'+$(this).find(".yd-start").text()+"</span></p></a>"}}else if(nowDateStartPosition<=can_dy_startPosition){lastHtml='<a style="width:'+(orderbtnwidth-.1)+"%;margin-left: "+(can_dy_startPosition+.1)+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+$(this).prev("a.done").find(".yd-end").text()+'</span><span class="yd-end">'+$(this).find(".yd-start").text()+"</span></p></a>"}}else{lastHtml='<a style="width:'+(orderbtnwidth-.2)+"%;margin-left: "+(can_dy_startPosition+.1)+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+$(this).prev("a.done").find(".yd-end").text()+'</span><span class="yd-end">'+$(this).find(".yd-start").text()+"</span></p></a>"}}}else{if(getToday===currentDay){if(nowDateStartPosition<=thismarginleft&&thismarginleft-nowDateStartPosition>2.4){lastHtml='<a style="width:'+(thismarginleft-nowDateStartPosition-.1)+"%;margin-left:"+nowDateStartPosition+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+common.myDate.dateFormat((new Date).setMinutes((new Date).getMinutes()+10),"hh:mm")+'</span><span class="yd-end">'+$(this).find(".yd-start").text()+"</span></p></a>"}}else{if(thismarginleft-.1>2.4){lastHtml='<a style="width:'+(thismarginleft-.1)+'%;margin-left:0%" class="can-dy" href="#"><p>＋预定<span class="yd-start">06:00</span><span class="yd-end">'+$(this).find(".yd-start").text()+"</span></p></a>"}}}$(this).before(lastHtml)});var last=$(".time-set .day"+i+" .hy-set a.done").last();var lastmarginleft=parseFloat($(last).css("margin-left").replace("px",""))/parentwidth*100;var lastwidth=parseFloat($(last).css("width").replace("px",""))/parentwidth*100;var lastorderbtnwidth=100-lastmarginleft-lastwidth;var lastorderbtnmarginleft=lastwidth+lastmarginleft;if(lastorderbtnwidth>2.4){var lastHtml="";if(getToday===currentDay){if(nowDateStartPosition>lastorderbtnmarginleft){lastorderbtnwidth=lastorderbtnwidth-(nowDateStartPosition-lastorderbtnmarginleft);lastorderbtnmarginleft=nowDateStartPosition;lastHtml='<a style="width:'+(lastorderbtnwidth-.1)+"%;margin-left: "+(nowDateStartPosition+.1)+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+common.myDate.dateFormat((new Date).setMinutes((new Date).getMinutes()+10),"hh:mm")+'</span><span class="yd-end">20:00</span></p></a>'}else{lastHtml='<a style="width:'+(lastorderbtnwidth-.1)+"%;margin-left: "+(lastorderbtnmarginleft+.1)+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+$(".time-set .day"+i+" .hy-set a.done").last().find("p span.yd-end").text()+'</span><span class="yd-end">20:00</span></p></a>'}}else{lastHtml='<a style="width:'+(lastorderbtnwidth-.1)+"%;margin-left: "+(lastorderbtnmarginleft+.1)+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+$(".time-set .day"+i+" .hy-set a.done").last().find("p span.yd-end").text()+'</span><span class="yd-end">20:00</span></p></a>'}$(".time-set .day"+i+" .hy-set").append(lastHtml)}}else{var preorderhtml="";if(currentDay!==getToday){nowDateStartPosition=0;preorderhtml='<a style="width:'+(100-nowDateStartPosition)+"%;margin-left:"+nowDateStartPosition+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">06:00</span><span class="yd-end">20:00</span></p></a>'}else{preorderhtml='<a style="width:'+(100-nowDateStartPosition)+"%;margin-left:"+nowDateStartPosition+'%" class="can-dy" href="#"><p>＋预定<span class="yd-start">'+common.myDate.dateFormat((new Date).setMinutes((new Date).getMinutes()+10),"hh:mm")+'</span><span class="yd-end">20:00</span></p></a>'}$(".time-set .day"+i+" .hy-set").html(preorderhtml)}}}}layer.close(layerIndex)},roomInfo:function(roomId){webserver.query(null,apipath.meeting.room.single+roomId,methods.search,function(error,data,layerIndex){$(".cur-page-txt span").html(roomId+" 号会议室使用详情");$(".hys-txt h2").html(data.roomName).siblings("p").html(data.roomFloor+"楼"+data.roomLocation+"室 &nbsp;|&nbsp; 容量"+data.roomSize+"人&nbsp; | &nbsp;"+data.typeName+"&nbsp; | &nbsp;"+common.arrayList(data.equipList,"equipName"," "));layer.close(layerIndex)})},showOrderModule:function(data,basicwidth){var orderDay=new Date(data.orderStarttime).getDay();var width=(parseInt(data.orderEndtime)-parseInt(data.orderStarttime))*basicwidth;var begintimestamp=Date.parse(new Date($(".time-set .day"+orderDay+" .week").attr("title")+" 06:00:00"));var marginleft=(parseInt(data.orderStarttime)-parseInt(begintimestamp))*basicwidth;var timestamp=Date.parse(new Date);var start=common.myDate.dateFormat(data.orderStarttime,"hh:mm");var end=common.myDate.dateFormat(data.orderEndtime,"hh:mm");var html="";if(parseInt(timestamp)>parseInt(data.orderStarttime)){html='<a style="width:'+(width-.1)+"%;margin-left:"+(marginleft+.1)+'%" class="done last-dy" href="#">'+'<input type="hidden" name="orderId" value="'+data.orderId+'" />'+'<p style="display: none">'+'<span class="title">会议主题：</span><span class="topic info">'+data.orderTopic+"</span><br>"+'<span class="title">预定用户：</span><span class="orderUser info">'+data.orderUsername+"</span><br>"+'<span class="title">会场主持：</span><span class="hostName info">'+(data.hostUser?data.hostUser.userName:'<span class="lightGrey">(无)</span>')+"</span><br>"+'<span class="title">起止时间：</span><span class="yd-start">'+start+'</span>-<span class="yd-end">'+end+"</span><br>"+'<span class="title">与会人员：</span><span class="attendName info">'+common.arrayList(data.attendList,"userName","、")+"</span></p>"+"</a>"}else{html='<a style="width:'+(width-.1)+"%;margin-left:"+(marginleft+.1)+'%" class="done lready-dy" href="#">'+'<input type="hidden" name="orderId" value="'+data.orderId+'" />'+'<p style="display: none">'+'<span class="title">会议主题：</span><span class="topic info">'+data.orderTopic+"</span><br>"+'<span class="title">预定用户：</span><span class="orderUser info">'+data.orderUsername+"</span><br>"+'<span class="title">会场主持：</span><span class="hostName info">'+(data.hostUser?data.hostUser.userName:'<span class="lightGrey">(无)</span>')+"</span><br>"+'<span class="title">起止时间：</span><span class="yd-start">'+start+'</span>-<span class="yd-end">'+end+"</span><br>"+'<span class="title">与会人员：</span><span class="attendName info">'+common.arrayList(data.attendList,"userName","、")+"</span></p>"+"</a>"}$(".time-set .day"+orderDay+" .hy-set").append(html)},callback_attendList:function(error,data,layerIndex){var html='<tr><th><input id="allcheck" type="checkbox" /></th>'+"<th>姓名</th>"+'<th style="width: 34%;">部门</th></tr>';for(var i=0;i<data.list.length;i++){html=html+'<tr><td><input type="checkbox" value="'+data.list[i].userId+'" name="attendUser" /></td>'+'<td class="userName">'+data.list[i].userName+"</td>"+"<td>"+data.list[i].deptName+"</td></tr>"}$("#drry .table-table").html(html);layer.close(layerIndex)},confirmOrder:function(roomId,PopBox_layerIndex,action,orderId){common.showPopbox("请确认会议室预定信息",$("#qryd"),function(){$("#qryd .qr-orderName").html($("#hysyd .orderUserName").html());$("#qryd .qr-orderDate").html($("#hysyd .orderDate").html());$("#qryd .qr-roomNumber").html(roomId);$("#qryd .qr-topic").html($("#topic").val());$("#qryd .qr-hostName").html($("#hostName").val());$("#qryd .qr-attendList").html($("#attendName").val());$("#qryd .qr-orderTime").html($("#meetingStartTime").val()+"-"+$("#meetingEndTime").val());var roomInfo=$(".top-chioce .hys-txt p").text().split("|");$("#qryd .qr-position").html(roomInfo[0]);$("#qryd .qr-personCount").html(roomInfo[1]);$("#qryd .qr-orderType").html(roomInfo[2]);$("#qryd .qr-equipName").html(roomInfo[3])},function(PopBoxConfirm_layerIndex){if(action==="add"){var params={};params.orderAttend=$("#attendId").val();params.orderEndtime=Date.parse($("#hysyd .t-table .orderDate").text()+" "+$("#meetingEndTime").val());params.orderHost=$("#hostNamehid").val();params.orderStarttime=Date.parse($("#hysyd .t-table .orderDate").text()+" "+$("#meetingStartTime").val());params.orderTopic=$("#topic").val();params.roomId=roomId;webserver.query(params,apipath.meeting.preOrder.add,methods.add,function(error,data,layerIndex){var textmsg="您已成功预定"+data.roomName+"会议室，并向与会人员发出邮件通知；<br>时间："+common.myDate.dateFormat(new Date(data.orderStarttime),"yyyy年MM月dd日")+" "+common.myDate.dateFormat(new Date(data.orderStarttime),"hh:mm")+" - "+common.myDate.dateFormat(new Date(data.orderEndtime),"hh:mm");common.showAlert(1,textmsg,function(index){layer.close(layerIndex);window.location.reload()})})}else if(action==="edit"){var params={};params.orderAttend=$("#attendId").val();params.orderEndtime=Date.parse($("#hysyd .t-table .orderDate").text()+" "+$("#meetingEndTime").val());params.orderHost=$("#hostNamehid").val();params.orderStarttime=Date.parse($("#hysyd .t-table .orderDate").text()+" "+$("#meetingStartTime").val());params.orderTopic=$("#topic").val();params.roomId=roomId;webserver.query(params,apipath.meeting.order.edit+orderId,methods.edit,function(error,data,layerIndex){layer.close(layerIndex);var textmsg="您已成功预定"+data.roomName+"会议室，并向与会人员发出邮件通知；<br>时间："+common.myDate.dateFormat(new Date(data.orderStarttime),"yyyy年MM月dd日")+" "+common.myDate.dateFormat(new Date(data.orderStarttime),"hh:mm")+" - "+common.myDate.dateFormat(new Date(data.orderEndtime),"hh:mm");common.showAlert(1,textmsg,function(index){layer.close(layerIndex);window.location.reload()})})}layer.close(PopBoxConfirm_layerIndex);layer.close(PopBox_layerIndex)})},cancelOrder:function(orderId,layerIndex){var params={};params.reason=$("#qxyd_reason").val();params.remark=$("#qxyd_mark").val();webserver.query(params,apipath.meeting.order.delete+orderId,methods.delete,function(error,data,layerIndex){layer.close(layerIndex)})}}}})(jQuery);