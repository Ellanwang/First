(function(){common={menusInitialization:function(){var user=common.cookies.get("!@#2017hd_user");var token=common.cookies.get("!@#2017hd_token");var userId=common.cookies.get("!@#2017hd_userId");if(user&&token&&userId){var user=JSON.parse(common.cookies.get("!@#2017hd_user"));var redpoint="";$(".top-box .name").html(user.userName);webserver.query({},apipath.user.info,methods.search,function(err,data,layerIndex){layer.close(layerIndex);if(data>0){redpoint='<i class="red-point"></i>';$(".top-box a .name").after('<span class="topInfocount">'+data+"</span>").parent().css("position","relative")}var infoHtml='<img class="head-img" src="../../images/pic1.png" />'+'<p class="name" title="'+user.userAccount+'"><span id="curr_user">'+(user.userAccount==""?'<span style="color:#cdcdcd">（空）</span>':user.userAccount)+'</span><a class="icon-bj" href="#"></a></p>'+'<p class="place" id="telNum">'+(user.userTel==""?'<span style="color:#cdcdcd">（空）</span>':user.userTel)+"</p>"+'<p class="place" title="'+user.userAddr+'" id="place">'+(user.userAddr==""?'<span style="color:#cdcdcd">（空）</span>':user.userAddr.substring(0,10)+"...")+"</p>"+'<div class="btn-tops">'+'<button id="alertBtn">修改密码</button>'+'<button id="notice">通知消息</button>'+redpoint;"</div>";$(".personal-box").html(infoHtml)});$(".top-box .btn-out").click(function(){common.showConfirm("请您确认退出系统","您打算退出当前账号吗？",function(){},function(){common.logout()})});var personalHtml='<div class="pop-box" id="message" style="display: none;">  '+'<ul class="tz-box">  </ul> </div> <div class="pop-box" id="modifyInfo" style="display: none;">  '+'<div class="pop-txt"> '+'<form id="usrInfoForm"><table class="t-table"> <tr> <td width="14%"> 登录名： </td> <td> <input type="text" maxlength="10" class="validate[required]" id="currName"/> </td> </tr> <tr> <td> 电话： </td> <td> <input class="validate[custom[phone]]" maxlength="13" id="telephone"/> </td> </tr> <tr> <td> 地址： </td> <td> <input maxlength="20" id="address1"/> </td> </tr> </table> </form> </div> </div>';$(".top-box").before(personalHtml);common.bindValidationEngine();$(".top-right>li>a").click(function(){$(".personal-box").toggleClass("hide")});$("body").delegate("#alertBtn","click",function(e){common.showIframe("修改密码","../my/editPassword.html")});$("body").delegate(".icon-bj","click",function(e){common.showPopbox("修改个人信息",$("#modifyInfo"),function(){user=JSON.parse(common.cookies.get("!@#2017hd_user"));$("#currName").val(user.userAccount);$("#telephone").val(user.userTel);$("#address1").val(user.userAddr)},function(layerIndex){if($("#usrInfoForm").validationEngine("validate")){layer.close(layerIndex);var param={};param.userAccount=$("#currName").val();param.userTel=$("#telephone").val();param.userAddr=$("#address1").val();param.userId=userId;webserver.query(param,apipath.users.modifyUser.edit+userId,methods.edit,function(err,data,layerIndex1){$(".personal-box").toggleClass("hide");common.cookies.set("!@#2017hd_user",data);layer.close(layerIndex1);layer.msg("修改成功，即将刷新本页面！",{icon:6,time:1500,end:function(){window.location.reload()}})})}})});$("body").delegate("#notice","click",function(e){common.showMsgbox("我的消息记录",$("#message"),function(){var param={page:1,rows:100};webserver.query(param,apipath.users.notice.list,methods.search,function(err,data,layerIndex){var html="";if(data.total&&data.total>0){for(var i=0;i<data.list.length;i++){if(data.list[i].readStatus===0){html=html+'<li class="myInfo noticeList">'}else{html=html+'<li class="noticeList">'}html=html+'<a href="#">'+'<span style="display:none" class="mid">'+data.list[i].umId+"</span>";if(data.list[i].readStatus===0){html=html+'<i class="r-p r-p-new"></i>'}html=html+'<span class="msg">'+data.list[i].msg+"</span></a></li>"}}$(".tz-box").html(html);layer.close(layerIndex)})})});$("body").delegate("li.noticeList.myInfo","click",function(e){var msgId=$(e.currentTarget).find("span.mid").text();var msg=$(e.currentTarget).find("span.msg").text();layer.open({type:1,title:false,closeBtn:false,area:"500px;",shade:.8,id:"myMsgBox",resize:false,btn:["了解"],btnAlign:"c",moveType:1,content:'<div style="padding: 50px; line-height: 22px; background-color: #393D49; color: #fff; font-weight: 300;">'+msg+"</div>",success:function(layero){var param={};param.umId=msgId;webserver.query(param,apipath.users.notice.edit+msgId,methods.edit);$(e.currentTarget).find("i.r-p").hide()},end:function(){var count=$(".top-right span.topInfocount").html();if(count){if(parseInt(count)>1){$(".top-right li:eq(0) span.topInfocount").html(parseInt(count)-1)}else{$(".top-right li:eq(0) span.topInfocount").remove();$(".top-right li:eq(0) div.personal-box div.btn-tops i.red-point").remove()}}}})})}else{layer.alert("此账号登录时间已过期，或在其他设备（地点）登录！",function(){window.location.href="../../login.html"});return}},bindValidationEngine:function(){common.myValidationEngine("form","attach","bottomLeft",{required:{message:"这里必须填写！"},"custom[positiveInteger]":{message:"这里必须填写正整数！"},'input[type="file"]':{required:{message:"上传文件不允许为空！"}},"#multipartFile":{required:{message:"上传文件不允许为空！"}},"#file":{required:{message:"上传文件不允许为空！"}},".systemUsers":{required:{message:"请输入系统中存在的用户！"}}})},showIframe:function(title,src,callback_OK){var index=layer.open({id:"iframe",resize:false,title:title,type:2,area:["462px","258px"],fixed:false,maxmin:false,content:[src,"no"]})},logout:function(){common.cookies.delete("!@#2017hd_user");common.cookies.delete("!@#2017hd_token");layer.msg("退出成功！",{icon:6,shade:.3,time:1e3},function(){window.location.href="../../login.html"})},arrayPutList:function(selector,spiltchar){var arrId=new Array;var arrName=new Array;$(selector).each(function(){arrId.push($(this).attr("value"));arrName.push($(this).parents().siblings(".userName").text())});var obj={};obj.id=arrId.join(",");obj.name=arrName.join("、");return obj},string2Array:function(str,spiltchar){str=str.split(spiltchar);var arr=new Array;for(var i=0;i<str.length;i++){if(str[i]!=="")arr.push(str[i])}return arr},mergeArray:function(target,newarr){var indexArray=new Array;for(var i=0;i<newarr.length;i++){var items=newarr[i];if($.inArray(items,target)==-1){target.push(items)}}return{repeatIndex:indexArray,mergeArray:target}},mergeArrayNotRemove:function(target,newarr){for(var i=0;i<newarr.length;i++){target.push(newarr[i])}return target},arrayList:function(data,name,spiltchar){var arr=new Array;for(var j=0;j<data.length;j++){if(data[j]){arr.push(data[j][name])}}return arr.join(spiltchar)},myDate:{setDate:{getCurrentDate:function(){var CurrentDate=new Date;common.myDate.serverDate("",function(err,data,layerIndex){CurrentDate=new Date(data.time);layer.close(layerIndex)});return CurrentDate},getCurrentWeek:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var week=currentDate.getDay();var month=currentDate.getDate();var millisecond=1e3*60*60*24;var minusDay=week!=0?week-1:6;var monday=new Date(currentDate.getTime()-minusDay*millisecond);var sunday=new Date(monday.getTime()+6*millisecond);startStop.push(monday);startStop.push(sunday);return startStop},getCurrentMonth:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var currentMonth=currentDate.getMonth();var currentYear=currentDate.getFullYear();var firstDay=new Date(currentYear,currentMonth,1);if(currentMonth==11){currentYear++;currentMonth=0}else{currentMonth++}var millisecond=1e3*60*60*24;var nextMonthDayOne=new Date(currentYear,currentMonth,1);var lastDay=new Date(nextMonthDayOne.getTime()-millisecond);startStop.push(firstDay);startStop.push(lastDay);return startStop},getQuarterSeasonStartMonth:function(month){var quarterMonthStart=0;var spring=0;var summer=3;var fall=6;var winter=9;if(month<3){return spring}if(month<6){return summer}if(month<9){return fall}return winter},getMonthDays:function(year,month){var relativeDate=new Date(year,month,1);var relativeMonth=relativeDate.getMonth();var relativeYear=relativeDate.getFullYear();if(relativeMonth==11){relativeYear++;relativeMonth=0}else{relativeMonth++}var millisecond=1e3*60*60*24;var nextMonthDayOne=new Date(relativeYear,relativeMonth,1);return new Date(nextMonthDayOne.getTime()-millisecond).getDate()},getCurrentSeason:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var currentMonth=currentDate.getMonth();var currentYear=currentDate.getFullYear();var quarterSeasonStartMonth=this.getQuarterSeasonStartMonth(currentMonth);var quarterSeasonEndMonth=quarterSeasonStartMonth+2;var quarterSeasonStartDate=new Date(currentYear,quarterSeasonStartMonth,1);var quarterSeasonEndDate=new Date(currentYear,quarterSeasonEndMonth,this.getMonthDays(currentYear,quarterSeasonEndMonth));startStop.push(quarterSeasonStartDate);startStop.push(quarterSeasonEndDate);return startStop},getCurrentYear:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var currentYear=currentDate.getFullYear();var currentYearFirstDate=new Date(currentYear,0,1);var currentYearLastDate=new Date(currentYear,11,31);startStop.push(currentYearFirstDate);startStop.push(currentYearLastDate);return startStop},getPriorMonthFirstDay:function(year,month){if(month==0){month=11;year--;return new Date(year,month,1)}month--;return new Date(year,month,1)},getPreviousMonth:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var currentMonth=currentDate.getMonth();var currentYear=currentDate.getFullYear();var priorMonthFirstDay=this.getPriorMonthFirstDay(currentYear,currentMonth);var priorMonthLastDay=new Date(priorMonthFirstDay.getFullYear(),priorMonthFirstDay.getMonth(),this.getMonthDays(priorMonthFirstDay.getFullYear(),priorMonthFirstDay.getMonth()));startStop.push(priorMonthFirstDay);startStop.push(priorMonthLastDay);return startStop},getPreviousWeek:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var week=currentDate.getDay();var month=currentDate.getDate();var millisecond=1e3*60*60*24;var minusDay=week!=0?week-1:6;var currentWeekDayOne=new Date(currentDate.getTime()-millisecond*minusDay);var priorWeekLastDay=new Date(currentWeekDayOne.getTime()-millisecond);var priorWeekFirstDay=new Date(priorWeekLastDay.getTime()-millisecond*6);startStop.push(priorWeekFirstDay);startStop.push(priorWeekLastDay);return startStop},getPriorSeasonFirstDay:function(year,month){var quarterMonthStart=0;var spring=0;var summer=3;var fall=6;var winter=9;switch(month){case spring:year--;month=winter;break;case summer:month=spring;break;case fall:month=summer;break;case winter:month=fall;break}return new Date(year,month,1)},getPreviousSeason:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var currentMonth=currentDate.getMonth();var currentYear=currentDate.getFullYear();var priorSeasonFirstDay=this.getPriorSeasonFirstDay(currentYear,currentMonth);var priorSeasonLastDay=new Date(priorSeasonFirstDay.getFullYear(),priorSeasonFirstDay.getMonth()+2,this.getMonthDays(priorSeasonFirstDay.getFullYear(),priorSeasonFirstDay.getMonth()+2));startStop.push(priorSeasonFirstDay);startStop.push(priorSeasonLastDay);return startStop},getPreviousYear:function(){var startStop=new Array;var currentDate=this.getCurrentDate();var currentYear=currentDate.getFullYear();currentYear--;var priorYearFirstDay=new Date(currentYear,0,1);var priorYearLastDay=new Date(currentYear,11,1);startStop.push(priorYearFirstDay);startStop.push(priorYearLastDay);return startStop}},DigitalUppercase:function(Digital){var Uppercase="星期";switch(Digital){case 1:Uppercase=Uppercase+"一";break;case 2:Uppercase=Uppercase+"二";break;case 3:Uppercase=Uppercase+"三";break;case 4:Uppercase=Uppercase+"四";break;case 5:Uppercase=Uppercase+"五";break;case 6:Uppercase=Uppercase+"六";break;case 0:Uppercase=Uppercase+"日";break}return Uppercase},serverDate:function(date,callback){var params={date:date};var layerIndex=null;$.ajax({type:"GET",url:apipath.server.date,data:params,dataType:"json",contentType:"application/json",async:false,timeout:3e3,beforeSend:function(){layerIndex=layer.msg("正在初始化当前时间...",{icon:16,shade:.3,time:0})},success:function(data){if(data.status===0){if(data.data){callback(null,data.data,layerIndex)}else{layer.msg("初始化时间失败！",{icon:5})}}else{layer.msg(data.msg,{icon:5})}},error:function(responseStr){layer.msg("初始化时间失败！",{icon:5})}})},dateFormat:function(obj,Format){if(obj=="Invalid Date"){return"/"}var newDate=new Date;newDate.setTime(obj);if(Format){return common.myDate.dateFormatBase(newDate,Format)}else{return newDate.toLocaleString()}},timeLength:function(s,e){var str="剩余";var tlength=e-s;if(tlength<0){return"已完成"}var minuts=0;var hours=0;var days=tlength/1e3/60/60/24;if(days>0){str=str+Math.floor(days)+"天";hours=(days-Math.floor(days))*24}else{hours=days*24}if(hours>0){str=str+Math.floor(hours)+"小时";minuts=(hours-Math.floor(hours))*60}else{str=str+"0小时";minuts=hours*60}if(minuts>0){str=str+Math.ceil(minuts)+"分钟"}else{str=str+"0分钟"}return str},FirstDayOfWeek:function(date){var day=date.getDay()||7;return new Date(date.getFullYear(),date.getMonth(),date.getDate()+1-day)},dateFormatBase:function(newDate,format){var date={"M+":newDate.getMonth()+1,"d+":newDate.getDate(),"h+":newDate.getHours(),"m+":newDate.getMinutes(),"s+":newDate.getSeconds(),"q+":Math.floor((newDate.getMonth()+3)/3),"S+":newDate.getMilliseconds()};if(/(y+)/i.test(format)){format=format.replace(RegExp.$1,(newDate.getFullYear()+"").substr(4-RegExp.$1.length))}for(var k in date){if(new RegExp("("+k+")").test(format)){format=format.replace(RegExp.$1,RegExp.$1.length==1?date[k]:("00"+date[k]).substr((""+date[k]).length))}}return format}},showPopbox:function(title,selector,callback_setvalue,callback_OK,callback_cancle){layer.open({type:1,title:common.singledisplayPart(title,40),closeBtn:1,area:"[462px]",shadeClose:false,resize:false,content:$(selector),btn:["确认","取消"],btnAlign:"c",yes:function(index,layero){callback_OK(index)},btn2:function(index,layero){if(callback_cancle){callback_cancle(index)}},cancel:function(index,layero){if(callback_cancle){callback_cancle(index)}},success:function(layero,index){callback_setvalue()}})},showMsgbox:function(title,selector,callback_setvalue){layer.open({type:1,title:title,shadeClose:false,shade:false,maxmin:true,area:["793px","500px"],content:$(selector).html(),success:function(layero,index){callback_setvalue()}})},showConfirm:function(title,text,callback_Cancel,callback_OK){layer.confirm(text,{resize:false,btn:["确定","取消"],title:title},function(){callback_OK()},function(){callback_Cancel()})},showPrompt:function(tilte,setvalue,callback){layer.prompt({title:tilte,formType:2,value:setvalue,maxlength:100},function(text,index){callback(text,index)})},showTips:function(html,selector,background,time){layer.tips(html,selector,{tips:[1,background],time:time,area:"auto",type:4})},showAlert:function(icon,text,callback){layer.alert(text,{icon:icon,closeBtn:0},function(index){callback();layer.close(index)})},showTimeMsg:function(icon,text){layer.msg(text,{icon:icon,shade:.3,time:2e3})},upload:function(selector,requestName,url,callback){var layerIndex=null;var formData=new FormData;formData.append(requestName,$(selector)[0].files[0]);$.ajax({url:url,type:"POST",data:formData,processData:false,contentType:false,beforeSend:function(){layerIndex=layer.msg("正在上传文件，请稍后...",{icon:16,shade:.3,time:0})},success:function(data){if(data.status===0){if(data.data){callback(null,data.data,layerIndex)}else if(data.msg){layer.msg(data.msg+"，即将刷新本页面！",{icon:6,time:1500,end:function(){window.location.reload()}})}}else{layer.msg(data.msg,{icon:5})}},error:function(responseStr){layer.msg("请求出错！",{icon:5})}})},cutUrl:function(url){if(url&&url.lastIndexOf("HD")){url=url.substr(url.lastIndexOf("HD"),url.length);return"http://121.42.224.143:8080/"+url}else{return"#"}},RandomNum:function(Min,Max){var Range=Max-Min;var Rand=Math.random();return Min+Math.round(Rand*Range)},cookies:{set:function(name,value){Cookies.set(name,value)},get:function(name){return Cookies.get(name)},delete:function(name){Cookies.remove(name)}},myValidform:function(form,btnSubmit){var formCheck=$(form).Validform({btnSubmit:btnSubmit,tiptype:function(msg,o,cssctl){if(!o.obj.is("form")){if(o.type===3){layer.msg(msg,{icon:2,shade:.3,time:1500},function(){$(o.obj).val("").focus()})}}},ajaxPost:true,datatype:{"pn1-2":/^[1-9]+[0-9]*]*$/},beforeCheck:function(curform){},beforeSubmit:function(curform){},callback:function(data){}});return formCheck},myValidationEngine:function(form,action,promptPosition,custom_error_messages){try{$(form).validationEngine(action,{binded:false,scroll:false,autoHideDelay:2e3,fadeDuration:.1,focusFirstField:false,promptPosition:promptPosition,autoPositionUpdate:true,autoHidePrompt:true,showOneMessage:true,maxErrorsPerField:1,validateNonVisibleFields:true,custom_error_messages:custom_error_messages})}catch(e){}},displayPart:function(selector){$(selector).each(function(){var displayLength=10;displayLength=$(this).attr("display-length")||displayLength;var text=$(this).text();if(!text)return"";var result="";var count=0;for(var i=0;i<displayLength;i++){var _char=text.charAt(i);if(count>=displayLength)break;if(/[^x00-xff]/.test(_char))count++;result+=_char;count++}if(result.length<text.length){result+="..."}$(this).attr("title",$(this).text());$(this).text(result)})},singledisplayPart:function(text,displayLength){if(!text)return"";var result="";var count=0;for(var i=0;i<displayLength;i++){var _char=text.charAt(i);if(count>=displayLength)break;if(/[^x00-xff]/.test(_char))count++;result+=_char;count++}if(result.length<text.length){result+="..."}return result}}})(jQuery);